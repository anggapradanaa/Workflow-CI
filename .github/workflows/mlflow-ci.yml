name: MLflow CI/CD Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'MLProject/**'
      - '.github/workflows/mlflow-ci.yml'
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Manual trigger

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mlflow==2.8.1
        pip install pandas==2.0.3 numpy==1.24.3 scikit-learn==1.3.0
        pip install lightgbm==4.1.0
        pip install matplotlib==3.7.2 seaborn==0.12.2
        pip install docker
    
    - name: Run MLflow Project
      run: |
        cd MLProject
        mlflow run . --env-manager=local
      env:
        MLFLOW_TRACKING_URI: file:./mlruns
    
    - name: List Artifacts
      run: |
        echo "=== Artifacts Created ==="
        ls -la MLProject/artifacts/
        cat MLProject/artifacts/metrics.json
        cat MLProject/artifacts/model_info.json
    
    - name: Save Artifacts to Repository
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add MLProject/artifacts/
        git add MLProject/mlruns/
        git diff --staged --quiet || git commit -m "ðŸ¤– CI: Auto-save model artifacts [skip ci]"
        git push || echo "No changes to push"
      continue-on-error: true
    
    - name: Get Model Info
      id: model_info
      run: |
        MODEL_NAME=$(cat MLProject/artifacts/model_info.json | python -c "import sys, json; print(json.load(sys.stdin)['model_name'])")
        MODEL_VERSION=$(cat MLProject/artifacts/model_info.json | python -c "import sys, json; print(json.load(sys.stdin)['model_version'])")
        RUN_ID=$(cat MLProject/artifacts/model_info.json | python -c "import sys, json; print(json.load(sys.stdin)['run_id'])")
        echo "model_name=$MODEL_NAME" >> $GITHUB_OUTPUT
        echo "model_version=$MODEL_VERSION" >> $GITHUB_OUTPUT
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "Model Name: $MODEL_NAME"
        echo "Model Version: $MODEL_VERSION"
        echo "Run ID: $RUN_ID"
    
    - name: Export Model from MLflow
      run: |
        cd MLProject
        MODEL_NAME="${{ steps.model_info.outputs.model_name }}"
        MODEL_VERSION="${{ steps.model_info.outputs.model_version }}"
        RUN_ID="${{ steps.model_info.outputs.run_id }}"
        
        echo "Exporting model: $MODEL_NAME version $MODEL_VERSION"
        
        # Copy model artifacts from mlruns
        mkdir -p model
        cp -r mlruns/*/*/artifacts/model/* model/ || cp -r mlruns/*/*/$RUN_ID/artifacts/model/* model/
        
        ls -la model/
      env:
        MLFLOW_TRACKING_URI: file:./mlruns
    
    - name: Create Dockerfile
      run: |
        cd MLProject
        cat > Dockerfile << 'EOF'
FROM python:3.10-slim

WORKDIR /app

# Install dependencies
RUN pip install --no-cache-dir \
    mlflow==2.8.1 \
    pandas==2.0.3 \
    numpy==1.24.3 \
    scikit-learn==1.3.0 \
    lightgbm==4.1.0 \
    gunicorn \
    flask

# Copy model
COPY model /app/model

# Expose port
EXPOSE 8080

# Set environment variables
ENV MLFLOW_TRACKING_URI=""
ENV MODEL_PATH=/app/model

# Run MLflow model server
CMD mlflow models serve -m /app/model -h 0.0.0.0 -p 8080 --no-conda
EOF
        cat Dockerfile
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and Push Docker Image
      run: |
        cd MLProject
        IMAGE_NAME="anggapradanaa/diabetes-lgbm-model"
        MODEL_VERSION="${{ steps.model_info.outputs.model_version }}"
        
        echo "Building Docker image: $IMAGE_NAME"
        
        # Build image
        docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:v$MODEL_VERSION .
        
        # Push both tags
        docker push $IMAGE_NAME:latest
        docker push $IMAGE_NAME:v$MODEL_VERSION
        
        echo "âœ“ Docker image pushed successfully!"
        echo "  - $IMAGE_NAME:latest"
        echo "  - $IMAGE_NAME:v$MODEL_VERSION"
    

    
    - name: Create Docker Hub Link File
      run: |
        mkdir -p MLProject/docker-info
        cat > MLProject/docker-info/Tautan_ke_Docker_Hub.txt << EOF
        =================================================================
        DOCKER HUB DEPLOYMENT INFO
        =================================================================
        Project: Diabetes Prediction with LightGBM
        CI/CD: GitHub Actions
        Author: Angga Yulian Adi Pradana
        Date: $(date)
        =================================================================
        
        Docker Hub Profile:
        https://hub.docker.com/u/anggapradanaa
        
        Docker Hub Repository:
        https://hub.docker.com/r/anggapradanaa/diabetes-lgbm-model
        
        Docker Image (Latest):
        anggapradanaa/diabetes-lgbm-model:latest
        
        Docker Image (Version):
        anggapradanaa/diabetes-lgbm-model:v${{ steps.model_info.outputs.model_version }}
        
        =================================================================
        PULL COMMAND
        =================================================================
        
        # Pull latest version:
        docker pull anggapradanaa/diabetes-lgbm-model:latest
        
        # Pull specific version:
        docker pull anggapradanaa/diabetes-lgbm-model:v${{ steps.model_info.outputs.model_version }}
        
        =================================================================
        RUN COMMAND
        =================================================================
        
        # Run the model server:
        docker run -p 5001:8080 anggapradanaa/diabetes-lgbm-model:latest
        
        # Test the endpoint:
        curl http://localhost:5001/ping
        
        # With custom port:
        docker run -p 8080:8080 anggapradanaa/diabetes-lgbm-model:latest
        
        =================================================================
        MODEL INFO
        =================================================================
        
        Model Name: ${{ steps.model_info.outputs.model_name }}
        Model Version: ${{ steps.model_info.outputs.model_version }}
        MLflow Run ID: ${{ steps.model_info.outputs.run_id }}
        
        =================================================================
        PREDICTION ENDPOINT
        =================================================================
        
        URL: http://localhost:5001/invocations
        Method: POST
        Content-Type: application/json
        
        Example Request:
        curl -X POST http://localhost:5001/invocations \\
          -H 'Content-Type: application/json' \\
          -d '{"inputs": [[...]]}'
        
        =================================================================
        EOF
        
        cat MLProject/docker-info/Tautan_ke_Docker_Hub.txt
    
    - name: Commit Docker Info
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add MLProject/docker-info/
        git diff --staged --quiet || git commit -m "ðŸ³ CI: Add Docker Hub deployment info [skip ci]"
        git push || echo "No changes to push"
      continue-on-error: true
    
    - name: Upload Artifacts to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: model-artifacts
        path: |
          MLProject/artifacts/
          MLProject/mlruns/
          MLProject/docker-info/
    
    - name: Summary
      run: |
        echo "==================================================================="
        echo "âœ“ CI/CD PIPELINE COMPLETED SUCCESSFULLY!"
        echo "==================================================================="
        echo ""
        echo "Model Information:"
        echo "  - Model Name: ${{ steps.model_info.outputs.model_name }}"
        echo "  - Model Version: ${{ steps.model_info.outputs.model_version }}"
        echo "  - Run ID: ${{ steps.model_info.outputs.run_id }}"
        echo ""
        echo "Docker Image:"
        echo "  - Repository: https://hub.docker.com/r/anggapradanaa/diabetes-lgbm-model"
        echo "  - Tag: anggapradanaa/diabetes-lgbm-model:latest"
        echo "  - Version: anggapradanaa/diabetes-lgbm-model:v${{ steps.model_info.outputs.model_version }}"
        echo ""
        echo "Artifacts:"
        echo "  - Saved to repository: MLProject/artifacts/"
        echo "  - Saved to GitHub Actions: Available in 'Artifacts' tab"
        echo ""
        echo "==================================================================="
