# Workflow CI/CD - Diabetes Prediction

## ğŸ“ Deskripsi Folder
Folder ini berisi implementasi **CI/CD Pipeline** menggunakan **GitHub Actions** dan **MLflow Project** untuk otomasi training, deployment, dan containerization model machine learning.

## ğŸ“‚ Struktur Folder
```
Workflow-CI/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ mlflow-ci.yml              # GitHub Actions workflow
â””â”€â”€ MLProject/
    â”œâ”€â”€ artifacts/                     # Generated artifacts (by CI)
    â”‚   â”œâ”€â”€ metrics.json
    â”‚   â”œâ”€â”€ model_info.json
    â”œâ”€â”€ diabetes_preprocessing/        # Preprocessed dataset
    â”‚   â”œâ”€â”€ X_train.csv
    â”‚   â”œâ”€â”€ X_test.csv
    â”‚   â”œâ”€â”€ y_train.csv
    â”‚   â””â”€â”€ y_test.csv
    â”œâ”€â”€ docker-info/                   # Docker deployment info (by CI)
    â”‚   â””â”€â”€ Tautan_ke_Docker_Hub.txt
    â”œâ”€â”€ mlruns/                        # MLflow tracking data (by CI)
    â”œâ”€â”€ model/                         # Exported model (by CI)
    â”œâ”€â”€ conda.yaml                     # Environment dependencies
    â”œâ”€â”€ MLProject                      # MLflow project configuration
    â”œâ”€â”€ modelling.py                   # Training script
    â”œâ”€â”€ Dockerfile                     # Generated by CI
    â””â”€â”€ README.md
```

## ğŸ”§ File Konfigurasi

### 1. **MLProject**
File konfigurasi MLflow Project yang mendefinisikan entry points dan environment.

```yaml
name: diabetes_lgbm_project

conda_env: conda.yaml

entry_points:
  main:
    command: "python modelling.py"
```

### 2. **conda.yaml**
Environment dependencies untuk reproducibility.

```yaml
name: diabetes_lgbm_env
channels:
  - conda-forge
  - defaults
dependencies:
  - python=3.10
  - pip
  - pip:
      - pandas==2.0.3
      - numpy==1.24.3
      - scikit-learn==1.3.0
      - lightgbm==4.1.0
      - mlflow==2.8.1
      - matplotlib==3.7.2
      - seaborn==0.12.2
```

### 3. **modelling.py**
Script training model yang akan dijalankan oleh MLflow Project (sama dengan file di folder Membangun_model).

## ğŸ”„ CI/CD Workflow

### **Triggers** - Kapan Workflow Berjalan?
```yaml
on:
  push:
    branches: [main]
    paths: ['MLProject/**', '.github/workflows/mlflow-ci.yml']
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger
```

**Pipeline berjalan saat:**
- ğŸ“¤ Push ke branch `main` (pada folder MLProject atau workflow file)
- ğŸ“¥ Pull request ke branch `main`
- ğŸ¯ Manual trigger (workflow_dispatch)

### **Pipeline Steps** (11 Jobs)

#### 1ï¸âƒ£ **Checkout Repository**
```bash
- Checkout code dari GitHub
```

#### 2ï¸âƒ£ **Set up Python 3.10**
```bash
- Install Python 3.10
```

#### 3ï¸âƒ£ **Install Dependencies**
```bash
- mlflow==2.8.1
- pandas, numpy, scikit-learn
- lightgbm==4.1.0
- matplotlib, seaborn
- docker
```

#### 4ï¸âƒ£ **Run MLflow Project**
```bash
cd MLProject
mlflow run . --env-manager=local
```
- Training model otomatis
- Tracking dengan MLflow
- Generate artifacts

#### 5ï¸âƒ£ **List Artifacts**
```bash
- Tampilkan artifacts yang dibuat
- metrics.json
- model_info.json
```

#### 6ï¸âƒ£ **Save Artifacts to Repository**
```bash
- Commit artifacts ke GitHub
- Auto-push dengan bot account
- Skip CI untuk commit ini ([skip ci])
```

#### 7ï¸âƒ£ **Get Model Info**
```bash
- Extract model_name
- Extract model_version
- Extract run_id
- Set sebagai output untuk step selanjutnya
```

#### 8ï¸âƒ£ **Export Model from MLflow**
```bash
- Find model path menggunakan run_id
- Copy model artifacts ke folder model/
- Siap untuk containerization
```

#### 9ï¸âƒ£ **Create Dockerfile**
```dockerfile
FROM python:3.10-slim
WORKDIR /app
RUN pip install mlflow pandas numpy scikit-learn lightgbm gunicorn flask
COPY model /app/model
EXPOSE 8080
CMD mlflow models serve -m /app/model -h 0.0.0.0 -p 8080 --no-conda
```

#### ğŸ”Ÿ **Build and Push Docker Image**
```bash
- Login ke Docker Hub
- Build image: anggapradanaa/diabetes-lgbm-model
- Tag: latest & v{version}
- Push kedua tags ke Docker Hub
```

#### 1ï¸âƒ£1ï¸âƒ£ **Create Docker Hub Link File**
```bash
- Generate Tautan_ke_Docker_Hub.txt
- Berisi: Docker Hub links, pull commands, run commands
- Info model dan prediction endpoint
```

#### **Additional Steps:**
- ğŸ“¤ Upload artifacts ke GitHub Actions
- ğŸ“ Commit docker-info ke repository
- ğŸ“Š Print summary

## ğŸ³ Docker Deployment

### **Docker Hub Repository**
```
https://hub.docker.com/r/anggapradanaa/diabetes-lgbm-model
```

### **Pull Docker Image**
```bash
# Latest version
docker pull anggapradanaa/diabetes-lgbm-model:latest

# Specific version
docker pull anggapradanaa/diabetes-lgbm-model:v{version}
```

### **Run Docker Container**
```bash
# Run model server
docker run -p 5001:8080 anggapradanaa/diabetes-lgbm-model:latest

# Test endpoint
curl http://localhost:5001/ping

# With custom port
docker run -p 8080:8080 anggapradanaa/diabetes-lgbm-model:latest
```

### **Prediction Endpoint**
```bash
# Make prediction
curl -X POST http://localhost:5001/invocations \
  -H 'Content-Type: application/json' \
  -d '{
    "inputs": [[
      6, 148, 72, 35, 0, 33.6, 0.627, 50
    ]]
  }'
```

## ğŸ¯ Outputs & Artifacts

### **Artifacts Generated:**
1. **metrics.json** - Model metrics (accuracy, precision, recall, etc.)
2. **model_info.json** - Model metadata (name, version, run_id)
3. **model/** - Exported MLflow model
4. **mlruns/** - MLflow tracking data
5. **Dockerfile** - Container configuration
6. **Tautan_ke_Docker_Hub.txt** - Docker deployment info

### **Artifact Storage:**
- âœ… **GitHub Repository** - Auto-commit ke `MLProject/artifacts/` dan `MLProject/docker-info/`
- âœ… **GitHub Actions** - Available di tab "Artifacts" setiap workflow run
- âœ… **Docker Hub** - Container images dengan versioning

## ğŸ“Š Workflow Monitoring

### **View Workflow Runs:**
```
GitHub Repository â†’ Actions â†’ MLflow CI/CD Pipeline
```

### **Check Docker Images:**
```
https://hub.docker.com/r/anggapradanaa/diabetes-lgbm-model/tags
```

### **Workflow Status Badge:**
```markdown
![MLflow CI/CD](https://github.com/[username]/[repo]/actions/workflows/mlflow-ci.yml/badge.svg)
```

## ğŸš€ Manual Trigger

Untuk menjalankan workflow secara manual:

1. Buka repository di GitHub
2. Navigasi ke **Actions** tab
3. Pilih **MLflow CI/CD Pipeline**
4. Klik **Run workflow**
5. Pilih branch `main`
6. Klik **Run workflow** hijau

## ğŸ” Required Secrets

Untuk Docker Hub deployment, tambahkan secrets di GitHub:

```
Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
```

**Secrets:**
- `DOCKER_USERNAME` - Username Docker Hub
- `DOCKER_PASSWORD` - Password/Token Docker Hub

## âœ… Success Criteria

Pipeline dianggap sukses jika:
- âœ… Model trained successfully
- âœ… Artifacts generated dan tersimpan
- âœ… Docker image built dan pushed ke Docker Hub
- âœ… Tautan_ke_Docker_Hub.txt dibuat
- âœ… Semua jobs completed tanpa error

## ğŸ“ Notes

### **Auto-commit Message:**
- `ğŸ¤– CI: Auto-save model artifacts [skip ci]`
- `ğŸ³ CI: Add Docker Hub deployment info [skip ci]`

**[skip ci]** mencegah infinite loop (commit â†’ trigger workflow â†’ commit â†’ ...)

### **Reproducibility:**
- Environment terdefinisi di `conda.yaml`
- MLflow tracking untuk experiment management
- Docker untuk deployment consistency

### **Versioning:**
- Model version auto-increment
- Docker images tagged dengan version
- Semua artifacts tracked di MLflow

---

**Author**: Angga Yulian Adi Pradana  
**CI/CD**: GitHub Actions + MLflow Project  
**Container**: Docker Hub  
