# Workflow CI/CD - Diabetes Prediction

## ğŸ“ Deskripsi Folder
Folder ini berisi implementasi **CI/CD Pipeline** menggunakan **GitHub Actions** dan **MLflow Project** untuk otomasi training, deployment, dan containerization model machine learning dengan **Random Forest**.

## ğŸ“‚ Struktur Folder
```
Workflow-CI/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ mlflow-ci.yml              # GitHub Actions workflow
â””â”€â”€ MLProject/
    â”œâ”€â”€ artifacts/                     # Generated artifacts (by CI)
    â”‚   â”œâ”€â”€ metrics.json
    â”‚   â””â”€â”€ model_info.json
    â”œâ”€â”€ diabetes_preprocessing/        # Preprocessed dataset
    â”‚   â”œâ”€â”€ X_train.csv
    â”‚   â”œâ”€â”€ X_test.csv
    â”‚   â”œâ”€â”€ y_train.csv
    â”‚   â””â”€â”€ y_test.csv
    â”œâ”€â”€ docker-info/                   # Docker deployment info (by CI)
    â”‚   â””â”€â”€ Tautan_ke_Docker_Hub.txt
    â”œâ”€â”€ mlruns/                        # MLflow tracking data (by CI)
    â”œâ”€â”€ model/                         # Exported model (by CI)
    â”œâ”€â”€ conda.yaml                     # Environment dependencies
    â”œâ”€â”€ MLProject                      # MLflow project configuration
    â”œâ”€â”€ modelling.py                   # Training script
    â”œâ”€â”€ Dockerfile                     # Generated by CI
    â””â”€â”€ README.md
```

## ğŸ”§ File Konfigurasi

### 1. **MLProject**
File konfigurasi MLflow Project yang mendefinisikan entry points dan environment.

```yaml
name: diabetes_rf_project

conda_env: conda.yaml

entry_points:
  main:
    command: "python modelling.py"
```

### 2. **conda.yaml**
Environment dependencies untuk reproducibility.

```yaml
name: diabetes_rf_env
channels:
  - conda-forge
  - defaults
dependencies:
  - python=3.10
  - pip
  - pip:
      - pandas==2.0.3
      - numpy==1.24.3
      - scikit-learn==1.3.0
      - mlflow==2.8.1
      - matplotlib==3.7.2
      - seaborn==0.12.2
```

### 3. **modelling.py**
Script training model yang akan dijalankan oleh MLflow Project.

**Features:**
- âœ… Load preprocessed data
- âœ… Train Random Forest model
- âœ… MLflow autologging enabled
- âœ… Model registration otomatis
- âœ… Generate artifacts (metrics.json, model_info.json)
- âœ… Support manual & MLflow Projects run

**Model Configuration:**
```python
RandomForestClassifier(
    n_estimators=100,
    max_depth=10,
    min_samples_split=5,
    min_samples_leaf=2,
    max_features='sqrt',
    random_state=42,
    n_jobs=-1
)
```

**Artifacts Generated:**
- `artifacts/metrics.json` - Model performance metrics
- `artifacts/model_info.json` - Model metadata (name, version, run_id)

## ğŸ”„ CI/CD Workflow

### **Triggers** - Kapan Workflow Berjalan?
```yaml
on:
  push:
    branches: [main]
    paths: ['MLProject/**', '.github/workflows/mlflow-ci.yml']
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger
```

**Pipeline berjalan saat:**
- ğŸ“¤ Push ke branch `main` (pada folder MLProject atau workflow file)
- ğŸ“¥ Pull request ke branch `main`
- ğŸ¯ Manual trigger (workflow_dispatch)

### **Pipeline Steps** (13 Jobs)

#### 1ï¸âƒ£ **Checkout Repository**
```bash
- Checkout code dari GitHub
- uses: actions/checkout@v3
```

#### 2ï¸âƒ£ **Set up Python 3.10**
```bash
- Install Python 3.10
- uses: actions/setup-python@v4
```

#### 3ï¸âƒ£ **Install Dependencies**
```bash
- mlflow==2.8.1
- pandas==2.0.3
- numpy==1.24.3
- scikit-learn==1.3.0
- matplotlib==3.7.2
- seaborn==0.12.2
- docker
```

#### 4ï¸âƒ£ **Run MLflow Project**
```bash
cd MLProject
mlflow run . --env-manager=local
```
- Training model otomatis dengan MLflow Project
- Tracking dengan MLflow (file:./mlruns)
- Generate artifacts otomatis

#### 5ï¸âƒ£ **List Artifacts**
```bash
- Tampilkan artifacts yang dibuat
- cat artifacts/metrics.json
- cat artifacts/model_info.json
```

#### 6ï¸âƒ£ **Save Artifacts to Repository**
```bash
- Commit artifacts ke GitHub
- Auto-push dengan github-actions bot
- Skip CI untuk commit ini ([skip ci])
```

#### 7ï¸âƒ£ **Get Model Info**
```bash
- Extract model_name dari model_info.json
- Extract model_version dari model_info.json
- Extract run_id dari model_info.json
- Set sebagai output untuk step selanjutnya
```

**Extracted Info:**
- `model_name`: "diabetes-rf-ci-model"
- `model_version`: Auto-increment version
- `run_id`: MLflow run ID

#### 8ï¸âƒ£ **Export Model from MLflow**
```bash
- Find model path menggunakan run_id
- Copy model artifacts ke folder model/
- Siap untuk containerization
```

**Process:**
```bash
MODEL_PATH=$(find mlruns -type d -name "$RUN_ID" | head -1)
cp -r $MODEL_PATH/artifacts/model/* model/
```

#### 9ï¸âƒ£ **Create Dockerfile**
```dockerfile
FROM python:3.10-slim

WORKDIR /app

RUN pip install --no-cache-dir \
    mlflow==2.8.1 \
    pandas==2.0.3 \
    numpy==1.24.3 \
    scikit-learn==1.3.0 \
    gunicorn \
    flask

COPY model /app/model

EXPOSE 8080

CMD mlflow models serve -m /app/model -h 0.0.0.0 -p 8080 --no-conda
```

#### ğŸ”Ÿ **Login to Docker Hub**
```bash
- Authenticate dengan Docker Hub
- uses: docker/login-action@v2
- Menggunakan secrets: DOCKER_USERNAME & DOCKER_PASSWORD
```

#### 1ï¸âƒ£1ï¸âƒ£ **Build and Push Docker Image**
```bash
- Build Docker image
- Tag: latest & v{version}
- Push kedua tags ke Docker Hub
```

**Images Created:**
```bash
anggapradanaa/diabetes-rf-model:latest
anggapradanaa/diabetes-rf-model:v{version}
```

#### 1ï¸âƒ£2ï¸âƒ£ **Create Docker Hub Link File**
```bash
- Generate Tautan_ke_Docker_Hub.txt
- Berisi:
  * Docker Hub links
  * Pull commands
  * Run commands
  * Model info
  * Prediction endpoint examples
```

#### 1ï¸âƒ£3ï¸âƒ£ **Commit Docker Info**
```bash
- Commit docker-info/ ke repository
- Auto-push dengan github-actions bot
- Message: "ğŸ³ CI: Add Docker Hub deployment info [skip ci]"
```

#### **Additional Steps:**
- ğŸ“¤ **Upload Artifacts to GitHub** - Store artifacts di GitHub Actions
- ğŸ“Š **Summary** - Print comprehensive pipeline summary

## ğŸ³ Docker Deployment

### **Docker Hub Repository**
```
https://hub.docker.com/r/anggapradanaa/diabetes-rf-model
```

### **Pull Docker Image**
```bash
# Latest version
docker pull anggapradanaa/diabetes-rf-model:latest

# Specific version
docker pull anggapradanaa/diabetes-rf-model:v{version}
```

### **Run Docker Container**
```bash
# Run model server (port 5001)
docker run -p 5001:8080 anggapradanaa/diabetes-rf-model:latest

# Test endpoint
curl http://localhost:5001/ping

# With custom port (8080)
docker run -p 8080:8080 anggapradanaa/diabetes-rf-model:latest
```

### **Prediction Endpoint**
```bash
# Health check
curl http://localhost:5001/ping

# Make prediction
curl -X POST http://localhost:5001/invocations \
  -H 'Content-Type: application/json' \
  -d '{
    "inputs": [[
      6, 148, 72, 35, 0, 33.6, 0.627, 50
    ]]
  }'
```

**Response Example:**
```json
{
  "predictions": [1]  // 0 = No Diabetes, 1 = Diabetes
}
```

## ğŸ¯ Outputs & Artifacts

### **Artifacts Generated by Pipeline:**
1. **metrics.json** - Model performance metrics
   ```json
   {
     "accuracy": 0.7273,
     "precision": 0.6234,
     "recall": 0.7123,
     "f1_score": 0.6645,
     "auc_roc": 0.8234
   }
   ```

2. **model_info.json** - Model metadata
   ```json
   {
     "model_name": "diabetes-rf-ci-model",
     "model_version": "4",
     "run_id": "ed98e1ebe8094e9db6a0b6dc6229dbb6",
     "model_uri": "runs:/{run_id}/model"
   }
   ```

3. **model/** - Exported MLflow model (MLmodel, model.pkl, requirements.txt)
4. **mlruns/** - MLflow tracking data
5. **Dockerfile** - Auto-generated container configuration
6. **Tautan_ke_Docker_Hub.txt** - Docker deployment info & commands

### **Artifact Storage Locations:**
- âœ… **GitHub Repository** - Auto-commit ke `MLProject/artifacts/` dan `MLProject/docker-info/`
- âœ… **GitHub Actions** - Available di tab "Artifacts" setiap workflow run (60-90 days retention)
- âœ… **Docker Hub** - Container images dengan versioning

## ğŸ“Š Workflow Monitoring

### **View Workflow Runs:**
```
GitHub Repository â†’ Actions â†’ MLflow CI/CD Pipeline
```

**Features:**
- Real-time logs untuk setiap step
- Artifact downloads
- Re-run failed workflows
- Workflow status & duration

### **Check Docker Images:**
```
https://hub.docker.com/r/anggapradanaa/diabetes-rf-model/tags
```

### **MLflow Tracking:**
```bash
cd MLProject
mlflow ui
# Access at http://localhost:5000
```

### **Workflow Status Badge:**
```markdown
![MLflow CI/CD](https://github.com/anggapradanaa/Membangun_model/actions/workflows/mlflow-ci.yml/badge.svg)
```

## ğŸš€ Manual Trigger

Untuk menjalankan workflow secara manual:

1. Buka repository di GitHub
2. Navigasi ke **Actions** tab
3. Pilih **MLflow CI/CD Pipeline**
4. Klik **Run workflow** (button)
5. Pilih branch `main`
6. Klik **Run workflow** (hijau)

## ğŸ” Required Secrets

Untuk Docker Hub deployment, tambahkan secrets di GitHub:

```
Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
```

**Required Secrets:**
- `DOCKER_USERNAME` - Username Docker Hub Anda
- `DOCKER_PASSWORD` - Password atau Personal Access Token Docker Hub

**Cara Membuat Docker Hub Token:**
1. Login ke Docker Hub
2. Account Settings â†’ Security â†’ New Access Token
3. Copy token dan paste sebagai `DOCKER_PASSWORD`

## âœ… Success Criteria

Pipeline dianggap sukses jika:
- âœ… Model trained successfully dengan Random Forest
- âœ… Artifacts generated (metrics.json, model_info.json)
- âœ… Model registered di MLflow
- âœ… Docker image built successfully
- âœ… Docker image pushed ke Docker Hub (2 tags)
- âœ… Tautan_ke_Docker_Hub.txt dibuat
- âœ… Artifacts auto-committed ke repository
- âœ… Semua 13 jobs completed tanpa error

## ğŸ¯ Expected Model Performance

Berdasarkan training dengan Random Forest (n_estimators=100, max_depth=10):

| Metric | Expected Range |
|--------|----------------|
| Accuracy | 0.72 - 0.76 |
| Precision | 0.60 - 0.70 |
| Recall | 0.70 - 0.75 |
| F1-Score | 0.65 - 0.72 |
| AUC-ROC | 0.80 - 0.85 |

## ğŸ“ Important Notes

### **Auto-commit Messages:**
- `ğŸ¤– CI: Auto-save model artifacts [skip ci]`
- `ğŸ³ CI: Add Docker Hub deployment info [skip ci]`

**[skip ci]** mencegah infinite loop:
```
commit â†’ trigger workflow â†’ new commit â†’ trigger workflow â†’ ...
```

### **Reproducibility:**
- âœ… Environment terdefinisi di `conda.yaml`
- âœ… MLflow tracking untuk experiment management
- âœ… Docker untuk deployment consistency
- âœ… Fixed random_state=42 untuk reproducible results

### **Versioning Strategy:**
- Model version auto-increment di MLflow
- Docker images tagged dengan version number
- Semua artifacts tracked dengan run_id
- Git commits untuk audit trail

### **Error Handling:**
- `continue-on-error: true` untuk git push steps
- Prevents pipeline failure jika tidak ada changes
- Full error logs available di GitHub Actions

## ğŸ”§ Troubleshooting

### **Pipeline Fails at "Run MLflow Project"**
```bash
# Check if data exists
ls -la MLProject/diabetes_preprocessing/

# Verify conda.yaml dependencies
cat MLProject/conda.yaml
```

### **Docker Push Fails**
```bash
# Verify secrets are set
Settings â†’ Secrets â†’ DOCKER_USERNAME & DOCKER_PASSWORD

# Check Docker Hub login
docker login -u YOUR_USERNAME
```

### **Model Not Found Error**
```bash
# Check if model was logged
ls -la MLProject/mlruns/

# Verify run_id exists
cat MLProject/artifacts/model_info.json
```

## ğŸ“š Local Development

### **Run MLflow Project Locally:**
```bash
cd MLProject
mlflow run . --env-manager=local
```

### **View MLflow UI:**
```bash
cd MLProject
mlflow ui
# Access at http://localhost:5000
```

### **Test Docker Image Locally:**
```bash
# Build
docker build -t diabetes-rf-model:test .

# Run
docker run -p 5001:8080 diabetes-rf-model:test

# Test
curl http://localhost:5001/ping
```

---

**Author**: Angga Yulian Adi Pradana  
**Model**: Random Forest Classifier  
**CI/CD**: GitHub Actions + MLflow Project  
**Container**: Docker Hub  
**Experiment Tracking**: MLflow
